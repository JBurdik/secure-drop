# Production Docker Compose for Dokploy
#
# Environment variables to set in Dokploy:
#   - VITE_CONVEX_URL: Full URL to Convex API (e.g., https://api.securedrop.example.com)
#   - FRONTEND_PORT: Frontend port (default: 3000)
#   - CONVEX_API_PORT: Convex API port (default: 3210)
#   - CONVEX_SITE_PORT: Convex HTTP actions port (default: 3211)
#   - DASHBOARD_PORT: Convex dashboard port (default: 6791)

services:
  # Convex Backend
  backend:
    image: ghcr.io/get-convex/convex-backend:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "${CONVEX_API_PORT:-3210}:3210"
      - "${CONVEX_SITE_PORT:-3211}:3211"
    volumes:
      - convex-data:/convex/data
    environment:
      - CONVEX_CLOUD_ORIGIN=${VITE_CONVEX_URL:-http://localhost:3210}
      - CONVEX_SITE_ORIGIN=${CONVEX_SITE_URL:-http://localhost:3211}
      - RUST_LOG=info
      - DOCUMENT_RETENTION_DELAY=172800
    healthcheck:
      test: curl -f http://localhost:3210/version
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_CONVEX_URL=${VITE_CONVEX_URL:-http://localhost:3210}
        - VITE_CONVEX_SITE_URL=${VITE_CONVEX_SITE_URL:-http://localhost:3211}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy

  # Convex Dashboard (optional)
  dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "${DASHBOARD_PORT:-6791}:6791"
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=${VITE_CONVEX_URL:-http://localhost:3210}
    depends_on:
      backend:
        condition: service_healthy

volumes:
  convex-data:
